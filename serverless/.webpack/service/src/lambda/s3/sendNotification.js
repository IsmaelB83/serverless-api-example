(()=>{"use strict";var e={d:(o,n)=>{for(var t in n)e.o(n,t)&&!e.o(o,t)&&Object.defineProperty(o,t,{enumerable:!0,get:n[t]})},o:(e,o)=>Object.prototype.hasOwnProperty.call(e,o),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},o={};e.r(o),e.d(o,{handler:()=>i}),require("source-map-support/register");const n=require("aws-sdk"),t=new n.DynamoDB.DocumentClient,s=process.env.CONNECTIONS_TABLE||"",a=process.env.STAGE,r={apiVersion:"2018-11-29",endpoint:`${process.env.API_ID}.execute-api.us-east-1.amazonaws.com/${a}`},c=new n.ApiGatewayManagementApi(r),i=async e=>{for(const o of e.Records){console.log("Processing SNS Record: ",o);const e=JSON.parse(o.Sns.Message);await l(e)}};async function l(e){console.log("Processing S3 event: ",e);const o=await t.scan({TableName:s}).promise();if(o.Items)for(const n of e.Records)for(const e of o.Items){const o=e.id;await d(o,{imageId:n.s3.object.key})}}async function d(e,o){try{console.log("Sending message to a connection: ",e),await c.postToConnection({ConnectionId:e,Data:JSON.stringify(o)}).promise()}catch(o){console.log("Failed to send the message: ",o),410===o.statusCode&&(console.log("Stale connection"),await t.delete({TableName:s,Key:{id:e}}))}}var p=exports;for(var g in o)p[g]=o[g];o.__esModule&&Object.defineProperty(p,"__esModule",{value:!0})})();
//# sourceMappingURL=sendNotification.js.map