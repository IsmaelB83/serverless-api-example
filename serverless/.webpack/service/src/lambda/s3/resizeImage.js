(()=>{"use strict";var e={n:t=>{var o=t&&t.__esModule?()=>t.default:()=>t;return e.d(o,{a:o}),o},d:(t,o)=>{for(var s in o)e.o(o,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:o[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{handler:()=>u}),require("source-map-support/register");const o=require("aws-sdk"),s=require("jimp/es");var r=e.n(s);const n=new o.S3,a=process.env.IMAGES_S3_BUCKET,i=process.env.THUMBNAILS_S3_BUCKET,c=process.env.IMAGES_ID_INDEX,p=process.env.IMAGES_TABLE,l=new o.DynamoDB.DocumentClient,u=async e=>{for(const t of e.Records){console.log("Processing SNS Record: ",t);const e=JSON.parse(t.Sns.Message);console.log("Processing S3 event: ",e);for(const t of e.Records){await d(t.s3.object.key);const e=await l.query({TableName:p,IndexName:c,KeyConditionExpression:"imageId = :imageId",ExpressionAttributeValues:{":imageId":t.s3.object.key}}).promise();if(console.log("Current item: ",e),e.Items){const o={TableName:p,Key:{groupId:e.Items[0].groupId,timestamp:e.Items[0].timestamp},UpdateExpression:"SET thumbnail = :s",ExpressionAttributeValues:{":s":`https://udagram-thumbnails-ibernal-dev.s3.amazonaws.com/${t.s3.object.key}`},ReturnValues:"ALL_NEW"};console.log("Update images table: ",o);try{const t=await l.update(o);await n.putObject({Bucket:i,Key:`log_${e.Items[0].timestamp}`,ContentType:"application/json",Body:JSON.stringify(t)}).promise(),console.log("Updated image item: ",t)}catch(e){console.log("Error updating: ",e)}}}}};async function d(e){const t=await n.getObject({Bucket:a,Key:e}).promise();console.log("S3 original item: ",t);const o=t.Body,s=await r().read(o);s.resize(150,r().AUTO);const c=await s.getBufferAsync(r().AUTO);await n.putObject({Bucket:i,Key:`${e}`,ContentType:t.ContentType,Body:c}).promise()}var m=exports;for(var y in t)m[y]=t[y];t.__esModule&&Object.defineProperty(m,"__esModule",{value:!0})})();
//# sourceMappingURL=resizeImage.js.map