(()=>{"use strict";var e={n:o=>{var t=o&&o.__esModule?()=>o.default:()=>o;return e.d(t,{a:t}),t},d:(o,t)=>{for(var s in t)e.o(t,s)&&!e.o(o,s)&&Object.defineProperty(o,s,{enumerable:!0,get:t[s]})},o:(e,o)=>Object.prototype.hasOwnProperty.call(e,o),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},o={};e.r(o),e.d(o,{handler:()=>u}),require("source-map-support/register");const t=require("aws-sdk"),s=require("jimp/es");var r=e.n(s);const n=new t.S3,a=process.env.IMAGES_S3_BUCKET,i=process.env.THUMBNAILS_S3_BUCKET,c=process.env.IMAGES_ID_INDEX,l=process.env.IMAGES_TABLE,d=new t.DynamoDB.DocumentClient,u=async e=>{for(const o of e.Records){console.log("Processing SNS Record: ",o);const e=JSON.parse(o.Sns.Message);console.log("Processing S3 event: ",e);for(const o of e.Records){await p(o.s3.object.key);const e=await d.query({TableName:l,IndexName:c,KeyConditionExpression:"imageId = :imageId",ExpressionAttributeValues:{":imageId":o.s3.object.key}}).promise();if(console.log("Current item: ",e),e.Items){const t={TableName:l,Key:{Id:e.Items[0].Id},UpdateExpression:"set thumbnail = :s",ExpressionAttributeValues:{":s":`https://udagram-thumbnails-ibernal-dev.s3.amazonaws.com/${o.s3.object.key}`},ReturnValues:"UPDATED_NEW"};console.log("Update images table: ",t);const s=await d.update(t);console.log("Updated image item: ",s)}}}};async function p(e){const o=await n.getObject({Bucket:a,Key:e}).promise();console.log("S3 original item: ",o);const t=o.Body,s=await r().read(t);s.resize(150,r().AUTO);const c=await s.getBufferAsync(r().AUTO);await n.putObject({Bucket:i,Key:`${e}`,ContentType:o.ContentType,Body:c}).promise()}var m=exports;for(var y in o)m[y]=o[y];o.__esModule&&Object.defineProperty(m,"__esModule",{value:!0})})();
//# sourceMappingURL=resizeImage.js.map